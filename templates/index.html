<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistema de detección de animales en peligro</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Estilos básicos integrados para asegurar que funcione sin style.css externo */
    #map { border-radius: 8px; border: 1px solid #ddd; }
    .video-container { background: #000; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Sistema de detección con IA</h4>
    <div class="btn-group">
      <a class="btn btn-outline-warning" href="/admin_camaras">⚙️ Configuración</a>
      <a class="btn btn-outline-primary" href="/dashboard">Dashboard</a>
      <a class="btn btn-outline-secondary" href="/registros">Registros</a>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card p-3 shadow-sm border-0">
        <h5>Selección de Cámara</h5>
        <select id="selectCam" class="form-select mb-2">
            </select>
        <button id="btnSelect" class="btn btn-success w-100 mb-3">Conectar cámara</button>

        <h6>Ubicación en Mapa</h6>
        <div id="map" style="height:280px;"></div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-3 mb-3 text-center shadow-sm border-0">
        <h5 id="videoTitle" class="text-primary">Vista en Tiempo Real</h5>
        <div class="video-container rounded border overflow-hidden">
            <img id="videoFeed" class="img-fluid"
                 src="/video_feed_cam/1" 
                 alt="Cargando señal de video..."
                 style="max-height:450px; width:100%; object-fit:contain;">
        </div>
      </div>

      <div class="card p-3 shadow-sm border-0">
        <h5>Últimos Detecciones</h5>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>Cámara</th><th>Fecha</th><th>Hora</th><th>Especie</th><th>Confianza</th>
              </tr>
            </thead>
            <tbody id="lastRecords">
                </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // 1. OBTENCIÓN DE DATOS DEL BACKEND (CORREGIDO CON | SAFE)
  const cameras = {{ cameras | tojson | safe }};

  const select = document.getElementById("selectCam");
  const video = document.getElementById("videoFeed");
  const title = document.getElementById("videoTitle");

  // 2. POBLAR EL SELECTOR DE CÁMARAS
  function populateSelect() {
    select.innerHTML = "";
    Object.entries(cameras).forEach(([id, cam]) => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = cam.nombre || `Cámara ${id}`;
      select.appendChild(opt);
    });
  }

  // 3. CAMBIO DE CÁMARA
  document.getElementById("btnSelect").onclick = () => {
    const id = select.value;
    // Añadimos timestamp para evitar el caché del navegador
    video.src = `/video_feed_cam/${id}?t=${new Date().getTime()}`;
    title.textContent = "Streaming: " + (cameras[id]?.nombre || `Cámara ${id}`);
  };

  // 4. INICIALIZACIÓN DEL MAPA
  const map = L.map('map').setView([9.0, -79.5], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Añadir marcadores de todas las cámaras configuradas
  Object.values(cameras).forEach(cam => {
    if (cam.lat && cam.lon) {
      L.marker([cam.lat, cam.lon])
        .addTo(map)
        .bindPopup(`<b>${cam.nombre}</b><br>ID: ${cam.device}`);
    }
  });

  // 5. CARGA DINÁMICA DE ÚLTIMOS REGISTROS
  async function loadLast() {
    try {
      const res = await fetch('/api/ultimos_registros');
      if (!res.ok) throw new Error('Error en la API');
      
      const data = await res.json();
      const tbody = document.getElementById("lastRecords");
      
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' class='text-center'>No hay detecciones recientes</td></tr>";
        return;
      }

      tbody.innerHTML = data.map(r => `
        <tr>
          <td><span class="badge bg-secondary">${r.camara}</span></td>
          <td>${r.fecha}</td>
          <td>${r.hora}</td>
          <td><strong class="text-success">${r.especie}</strong></td>
          <td>${(r.confianza * 100).toFixed(1)}%</td>
        </tr>
      `).join('');
    } catch (err) {
      console.error("Error al actualizar registros:", err);
    }
  }

  // Ejecución inicial
  populateSelect();
  loadLast();

  // Actualización automática de la tabla cada 5 segundos
  setInterval(loadLast, 5000);
</script>
</body>
</html>